// "FJz6HUAIi89VbIFjSJrygNposTA+n9uc+tiPiJJ0m7nI2+nlVWTGX5rUmDs1cDZ0pJVWoPLmftx2svcw4AGv/9wmFpJ3sMda0Sfn59d4k1giWxT7oNx57YmZgd39hA0m0+25vmA0zGxNlTKTqZRNrDAsPQzDjonz/r6s2A3+IgnQ9Exyjh57TCJGEgQthOwq992XIHf/g7ygdMgtU0ys5JYia2nzwTbyh3UODWAEbn/okKCA9e/3jsKdnYjVI8pjrksyUq6vAr8ihEw1ji70R1rHlrhTcVW6gTT9ps0NzxRuBpjEhh/fqt/7ZUqVIm8gEFD3Cs1zurQ1TdpMTI6zKV3KiLEH18ZRY25dOYdXErKqHz40cXtmoCnJMdhN5DXN9++yk9rEFAta1LH7QLX6JQ==": {
//     "solutionKey": "ab1c73abefb98e87a10b47fe7c0b21e2",
//     "solutionId": "FJz6HUAIi89VbIFjSJrygNposTA+n9uc+tiPiJJ0m7nI2+nlVWTGX5rUmDs1cDZ0pJVWoPLmftx2svcw4AGv/9wmFpJ3sMda0Sfn59d4k1giWxT7oNx57YmZgd39hA0m0+25vmA0zGxNlTKTqZRNrDAsPQzDjonz/r6s2A3+IgnQ9Exyjh57TCJGEgQthOwq992XIHf/g7ygdMgtU0ys5JYia2nzwTbyh3UODWAEbn/okKCA9e/3jsKdnYjVI8pjrksyUq6vAr8ihEw1ji70R1rHlrhTcVW6gTT9ps0NzxRuBpjEhh/fqt/7ZUqVIm8gEFD3Cs1zurQ1TdpMTI6zKV3KiLEH18ZRY25dOYdXErKqHz40cXtmoCnJMdhN5DXN9++yk9rEFAta1LH7QLX6JQ==",
//     "fareType": "PRIVATE",
//     "currency": "USD",
//     "adtFare": 172.46,
//     "adtTax": 42.95,
//     "chdFare": 0,
//     "chdTax": 0,
//     "qCharge": 0,
//     "tktFee": 0,
//     "platformServiceFee": 0,
//     "comments": null,
//     "journeys": {
//         "journey_0": {
//             "bc9c0c2a87294c547e3291c8c5ca8559": {
//                 "flightId": "bc9c0c2a87294c547e3291c8c5ca8559",
//                 "journeyTime": 380,
//                 "transferCount": 1,
//                 "lastTktTime": null,
//                 "segments": {
//                     "3ea72c4990d65929a76f0a3fcfea9966": {
//                         "segmentId": "3ea72c4990d65929a76f0a3fcfea9966",
//                         "airline": "VY",
//                         "flightNum": "7839",
//                         "equipment": "320",
//                         "cabinClass": "ECONOMY",
//                         "bookingCode": "T",
//                         "availabilityCount": 2,
//                         "departure": "LGW",
//                         "arrival": "BCN",
//                         "departureTerminal": "S",
//                         "arrivalTerminal": "1",
//                         "departureDate": 1741560600000,
//                         "arrivalDate": 1741571700000,
//                         "flightTime": 125,
//                         "stayTime": null,
//                         "codeShare": "N",
//                         "opFltNo": null,
//                         "opFltAirline": null,
//                         "stopover": null,
//                         "fareBasis": "YOW",
//                         "strDepartureDate": "2025-03-10",
//                         "strDepartureTime": "06:50",
//                         "strArrivalDate": "2025-03-10",
//                         "strArrivalTime": "09:55"
//                     },
//                     "3190cc3b0e00164fa45fda2676c51f29": {
//                         "segmentId": "3190cc3b0e00164fa45fda2676c51f29",
//                         "airline": "VY",
//                         "flightNum": "7894",
//                         "equipment": "320",
//                         "cabinClass": "ECONOMY",
//                         "bookingCode": "T",
//                         "availabilityCount": 2,
//                         "departure": "BCN",
//                         "arrival": "CAI",
//                         "departureTerminal": "1",
//                         "arrivalTerminal": "2",
//                         "departureDate": 1741597800000,
//                         "arrivalDate": 1741616700000,
//                         "flightTime": 255,
//                         "stayTime": null,
//                         "codeShare": "N",
//                         "opFltNo": null,
//                         "opFltAirline": null,
//                         "stopover": null,
//                         "fareBasis": "YOW",
//                         "strDepartureDate": "2025-03-10",
//                         "strDepartureTime": "17:10",
//                         "strArrivalDate": "2025-03-10",
//                         "strArrivalTime": "22:25"
//                     }
//                 }
//             }
//         }
//     },
//     "fareRule": null,
//     "rule": null,
//     "platingCarrier": "VY",
//     "prices": null,
//     "merchantFee": 0,
//     "adults": 1,
//     "children": 0,
//     "infants": 0,
//     "baggageMap": {
//         "ADT": [
//             {
//                 "segmentIndexList": [
//                     1
//                 ],
//                 "baggageAmount": "0PC",
//                 "baggageWeight": null,
//                 "carryOnAmount": "0PC",
//                 "carryOnWeight": "0KG",
//                 "carryOnSize": null
//             },
//             {
//                 "segmentIndexList": [
//                     2
//                 ],
//                 "baggageAmount": "0PC",
//                 "baggageWeight": null,
//                 "carryOnAmount": "0PC",
//                 "carryOnWeight": "0KG",
//                 "carryOnSize": null
//             }
//         ]
//     },
//     "miniRuleMap": {
//         "ADT": [
//             {
//                 "segmentIndex": [
//                     1,
//                     2
//                 ],
//                 "miniRules": [
//                     {
//                         "penaltyType": 0,
//                         "isPermited": 0,
//                         "when": 0,
//                         "noShowTime": null,
//                         "noShowTimeUnit": null,
//                         "amount": null,
//                         "currencyCode": null,
//                         "percent": null,
//                         "baseType": null
//                     },
//                     {
//                         "penaltyType": 2,
//                         "isPermited": 0,
//                         "when": 0,
//                         "noShowTime": null,
//                         "noShowTimeUnit": null,
//                         "amount": null,
//                         "currencyCode": null,
//                         "percent": null,
//                         "baseType": null
//                     }
//                 ]
//             }
//         ]
//     },
//     "afterSaleRule": null
// },
// "2fkGXWtC5ZNS55vFVoZwGcFWfq9p+0FkqEqzbyLnxU70V1xGzqIl3B2POFdzDj7xMMWn4d2F6bnSaf0y6QJmmxuu43vAUXczkTxn/JLcC7E/wK8CXCfC40Bnj4ongJ8syFnn9Ky4x1CTRiJpLsC4MAARMMSBVWtxSDjqyI1NmXiHXFgGJ0+lW/q7JGKJIPwP+GZ3sn3QbWsTcknQoiHIsIqVK5jNH79/X1lNj+Zb79X2wFsp5fTzRyocbM8hh/Q33XXfLF/+aB4WysIo2gwR5O1hwJU3rOmvVogn8wSVyk8r6O6etRbrzlKAOAW5XDUCHSDU3CenUTx0JiSNpKu1AyixBuOLee3Lvl0P3rv6k+2AeMD75iZAguh5DEUSjBHxQqyyYxGaj3tejXIdDMj49g==": {
//     "solutionKey": "71d72e6c03ddca2a05cc5bb40c1a2ff8",
//     "solutionId": "2fkGXWtC5ZNS55vFVoZwGcFWfq9p+0FkqEqzbyLnxU70V1xGzqIl3B2POFdzDj7xMMWn4d2F6bnSaf0y6QJmmxuu43vAUXczkTxn/JLcC7E/wK8CXCfC40Bnj4ongJ8syFnn9Ky4x1CTRiJpLsC4MAARMMSBVWtxSDjqyI1NmXiHXFgGJ0+lW/q7JGKJIPwP+GZ3sn3QbWsTcknQoiHIsIqVK5jNH79/X1lNj+Zb79X2wFsp5fTzRyocbM8hh/Q33XXfLF/+aB4WysIo2gwR5O1hwJU3rOmvVogn8wSVyk8r6O6etRbrzlKAOAW5XDUCHSDU3CenUTx0JiSNpKu1AyixBuOLee3Lvl0P3rv6k+2AeMD75iZAguh5DEUSjBHxQqyyYxGaj3tejXIdDMj49g==",
//     "fareType": "PRIVATE",
//     "currency": "USD",
//     "adtFare": 180.84,
//     "adtTax": 45.04,
//     "chdFare": 0,
//     "chdTax": 0,
//     "qCharge": 0,
//     "tktFee": 0,
//     "platformServiceFee": 0,
//     "comments": null,
//     "journeys": {
//         "journey_0": {
//             "08540fc7a8bbc3ea85c6785a00d8770b": {
//                 "flightId": "08540fc7a8bbc3ea85c6785a00d8770b",
//                 "journeyTime": 380,
//                 "transferCount": 1,
//                 "lastTktTime": null,
//                 "segments": {
//                     "4000192d8b719566b8922f5a4b60e6c9": {
//                         "segmentId": "4000192d8b719566b8922f5a4b60e6c9",
//                         "airline": "VY",
//                         "flightNum": "7833",
//                         "equipment": "320",
//                         "cabinClass": "ECONOMY",
//                         "bookingCode": "Z",
//                         "availabilityCount": 2,
//                         "departure": "LGW",
//                         "arrival": "BCN",
//                         "departureTerminal": "S",
//                         "arrivalTerminal": "1",
//                         "departureDate": 1741582200000,
//                         "arrivalDate": 1741593300000,
//                         "flightTime": 125,
//                         "stayTime": null,
//                         "codeShare": "N",
//                         "opFltNo": null,
//                         "opFltAirline": null,
//                         "stopover": null,
//                         "fareBasis": "YOW",
//                         "strDepartureDate": "2025-03-10",
//                         "strDepartureTime": "12:50",
//                         "strArrivalDate": "2025-03-10",
//                         "strArrivalTime": "15:55"
//                     },
//                     "3190cc3b0e00164fa45fda2676c51f29": {
//                         "segmentId": "3190cc3b0e00164fa45fda2676c51f29",
//                         "airline": "VY",
//                         "flightNum": "7894",
//                         "equipment": "320",
//                         "cabinClass": "ECONOMY",
//                         "bookingCode": "T",
//                         "availabilityCount": 2,
//                         "departure": "BCN",
//                         "arrival": "CAI",
//                         "departureTerminal": "1",
//                         "arrivalTerminal": "2",
//                         "departureDate": 1741597800000,
//                         "arrivalDate": 1741616700000,
//                         "flightTime": 255,
//                         "stayTime": null,
//                         "codeShare": "N",
//                         "opFltNo": null,
//                         "opFltAirline": null,
//                         "stopover": null,
//                         "fareBasis": "YOW",
//                         "strDepartureDate": "2025-03-10",
//                         "strDepartureTime": "17:10",
//                         "strArrivalDate": "2025-03-10",
//                         "strArrivalTime": "22:25"
//                     }
//                 }
//             }
//         }
//     },
//     "fareRule": null,
//     "rule": null,
//     "platingCarrier": "VY",
//     "prices": null,
//     "merchantFee": 0,
//     "adults": 1,
//     "children": 0,
//     "infants": 0,
//     "baggageMap": {
//         "ADT": [
//             {
//                 "segmentIndexList": [
//                     1
//                 ],
//                 "baggageAmount": "0PC",
//                 "baggageWeight": null,
//                 "carryOnAmount": "0PC",
//                 "carryOnWeight": "0KG",
//                 "carryOnSize": null
//             },
//             {
//                 "segmentIndexList": [
//                     2
//                 ],
//                 "baggageAmount": "0PC",
//                 "baggageWeight": null,
//                 "carryOnAmount": "0PC",
//                 "carryOnWeight": "0KG",
//                 "carryOnSize": null
//             }
//         ]
//     },
//     "miniRuleMap": {
//         "ADT": [
//             {
//                 "segmentIndex": [
//                     1,
//                     2
//                 ],
//                 "miniRules": [
//                     {
//                         "penaltyType": 0,
//                         "isPermited": 0,
//                         "when": 0,
//                         "noShowTime": null,
//                         "noShowTimeUnit": null,
//                         "amount": null,
//                         "currencyCode": null,
//                         "percent": null,
//                         "baseType": null
//                     },
//                     {
//                         "penaltyType": 2,
//                         "isPermited": 0,
//                         "when": 0,
//                         "noShowTime": null,
//                         "noShowTimeUnit": null,
//                         "amount": null,
//                         "currencyCode": null,
//                         "percent": null,
//                         "baseType": null
//                     }
//                 ]
//             }
//         ]
//     },
//     "afterSaleRule": null
// },

import 'package:equatable/equatable.dart';
import 'package:flymefy/features/Home/domain/entity/flight_search.dart';

class Flights extends Equatable {
  final List<Flight> flights;

  const Flights({
    this.flights = const [],
  });

  @override
  List<Object?> get props => [flights];

  Flights copyWith({
    List<Flight>? flights,
  }) {
    return Flights(
      flights: flights ?? this.flights,
    );
  }
}

class Flight extends Equatable {
  final String solutionKey;
  final String solutionId;
  final String fareType;
  final String currency;

  final String qCharge;
  final String tktFee;
  final String platformServiceFee;
  final String? comments;
  final List<JourneyUi> journeys;
  final String? fareRule;
  final String? rule;
  final String platingCarrier;
  final String? prices;
  final String merchantFee;
  final Map<String, List<Baggage>> baggageMap;
  final Map<String, List<MiniRule>> miniRuleMap;
  final String? afterSaleRule;

  final int adults;
  final int children;
  final int infants;

  final String adtFare;
  final String adtTax;
  final String chdFare;
  final String chdTax;
  final String infFare;
  final String infTax;
//make a fucntion to calculate total price of the flight * number of passengers
  // Method to get baggage details based on the passenger type (ADT, CHILD, INFANT)
  List<Baggage> getBaggageForPassengerType(String passengerType) {
    switch (passengerType) {
      case 'ADT': // Adult baggage
        return baggageMap['ADT'] ?? [];
      case 'CHILD': // Child baggage
        return baggageMap['CHI'] ?? [];
      case 'INFANT': // Infant baggage
        return baggageMap['CHD'] ?? [];
      default:
        return []; // Return empty if invalid passenger type
    }
  }

  // Getter for isCancellationAllowed
  bool get isCancellationAllowedDynamic {
    return miniRuleMap.values.any((rules) => rules.any(
        (miniRule) => miniRule.penaltyType == 0 && miniRule.isPermited == 1));
  }

  // Getter for isDateChangeAllowed
  bool get isDateChangeAllowedDynamic {
    return miniRuleMap.values.any((rules) => rules.any(
        (miniRule) => miniRule.penaltyType == 2 && miniRule.isPermited == 1));
  }

String getCancellationFeeDynamic(String passengerType, int index) {

  if (!isCancellationAllowedDynamic) {
    return "Cancellation not allowed";
  }

  final cancellationRules = miniRuleMap[passengerType]?.where(
    (miniRule) => miniRule.penaltyType == 0 && miniRule.isPermited == 1,
  ).toList();

  if (cancellationRules == null || cancellationRules.isEmpty) {
    return "No cancellation rules found for $passengerType.";
  }

  if (index < 0 || index >= cancellationRules.length) {
    return "Invalid index provided.";
  }

  final cancellationRule = cancellationRules[index];

  return "Cancellation fee starting ₹ ${cancellationRule.amount ?? 'N/A'}";
}

String getDateChangeFeeDynamic(String passengerType, int index) {

  if (!isDateChangeAllowedDynamic) {
    return "Date change not allowed";
  }

  final dateChangeRules = miniRuleMap[passengerType]?.where(
    (miniRule) => miniRule.penaltyType == 2 && miniRule.isPermited == 1,
  ).toList();

  if (dateChangeRules == null || dateChangeRules.isEmpty) {
    return "No date change rules found for $passengerType.";
  }

  if (index < 0 || index >= dateChangeRules.length) {
    return "Invalid index provided.";
  }

  final dateChangeRule = dateChangeRules[index];

  return "Date Change fee starting ₹ ${dateChangeRule.amount ?? 'N/A'}";
}


  double get totalPrice {
    return (double.parse(adtFare) + double.parse(adtTax)) * adults +
        (double.parse(chdFare) + double.parse(chdTax)) * children +
        (double.parse(infFare) + double.parse(infTax)) * infants;
  }

  const Flight({
    this.solutionKey = '',
    this.solutionId = '',
    this.fareType = '',
    this.currency = '',
    this.adtFare = '',
    this.adtTax = '',
    this.chdFare = '',
    this.chdTax = '',
    this.qCharge = '',
    this.tktFee = '',
    this.platformServiceFee = '',
    this.comments,
    this.journeys = const [],
    this.fareRule,
    this.rule,
    this.platingCarrier = '',
    this.prices,
    this.merchantFee = '',
    this.adults = 0,
    this.children = 0,
    this.infants = 0,
    this.baggageMap = const {},
    this.miniRuleMap = const {},
    this.afterSaleRule,
    this.infFare = "0",
    this.infTax = "0",
  });

  Flight copyWith({
    String? solutionKey,
    String? solutionId,
    String? fareType,
    String? currency,
    String? adtFare,
    String? adtTax,
    String? chdFare,
    String? chdTax,
    String? qCharge,
    String? tktFee,
    String? platformServiceFee,
    String? comments,
    List<JourneyUi>? journeys,
    String? fareRule,
    String? rule,
    String? platingCarrier,
    String? prices,
    String? merchantFee,
    int? adults,
    int? children,
    int? infants,
    Map<String, List<Baggage>>? baggageMap,
    Map<String, List<MiniRule>>? miniRuleMap,
    String? afterSaleRule,
    String? infFare,
    String? infTax,
  }) {
    return Flight(
      solutionKey: solutionKey ?? this.solutionKey,
      solutionId: solutionId ?? this.solutionId,
      fareType: fareType ?? this.fareType,
      currency: currency ?? this.currency,
      adtFare: adtFare ?? this.adtFare,
      adtTax: adtTax ?? this.adtTax,
      chdFare: chdFare ?? this.chdFare,
      chdTax: chdTax ?? this.chdTax,
      qCharge: qCharge ?? this.qCharge,
      tktFee: tktFee ?? this.tktFee,
      platformServiceFee: platformServiceFee ?? this.platformServiceFee,
      comments: comments ?? this.comments,
      journeys: journeys ?? this.journeys,
      fareRule: fareRule ?? this.fareRule,
      rule: rule ?? this.rule,
      platingCarrier: platingCarrier ?? this.platingCarrier,
      prices: prices ?? this.prices,
      merchantFee: merchantFee ?? this.merchantFee,
      adults: adults ?? this.adults,
      children: children ?? this.children,
      infants: infants ?? this.infants,
      baggageMap: baggageMap ?? this.baggageMap,
      miniRuleMap: miniRuleMap ?? this.miniRuleMap,
      afterSaleRule: afterSaleRule ?? this.afterSaleRule,
      infFare: infFare ?? this.infFare,
      infTax: infTax ?? this.infTax,
    );
  }

  factory Flight.fromMap(Map<String, dynamic> map) {
    return Flight(
      solutionKey: map['solutionKey'] ?? '',
      solutionId: map['solutionId'] ?? '',
      fareType: map['fareType'] ?? '',
      currency: map['currency'] ?? '',
      adtFare: map['adtFare']?.toString() ?? '',
      adtTax: map['adtTax']?.toString() ?? '',
      chdFare: map['chdFare']?.toString() ?? '',
      chdTax: map['chdTax']?.toString() ?? '',
      qCharge: map['qCharge']?.toString() ?? '',
      tktFee: map['tktFee']?.toString() ?? '',
      platformServiceFee: map['platformServiceFee']?.toString() ?? '',
      comments: map['comments'],
      journeys: (map['journeys'] as Map<String, dynamic>?)
              ?.map((journeyKey, journeyData) {
                return MapEntry(
                  journeyKey,
                  JourneyUi.fromMap(journeyData as Map<String, dynamic>),
                );
              })
              .values
              .toList() ??
          [],
      fareRule: map['fareRule'],
      rule: map['rule'],
      platingCarrier: map['platingCarrier'] ?? '',
      prices: map['prices'],
      merchantFee: map['merchantFee']?.toString() ?? '',
      adults: map['adults'] ?? 0,
      children: map['children'] ?? 0,
      infants: map['infants'] ?? 0,
      baggageMap: (map['baggageMap'] as Map<String, dynamic>?)?.map(
              (key, value) => MapEntry(key,
                  List<Baggage>.from(value.map((x) => Baggage.fromMap(x))))) ??
          {},
      miniRuleMap: (map['miniRuleMap'] as Map<String, dynamic>?)?.map(
              (key, value) => MapEntry(
                  key,
                  List<MiniRule>.from(
                      value.map((x) => MiniRule.fromMap(x))))) ??
          {},
      afterSaleRule: map['afterSaleRule']?.toString() ?? "0",
      infFare: map['infFare']?.toString() ?? "0",
      infTax: map['infTax']?.toString() ?? "0",
    );
  }

  @override
  List<Object?> get props => [
        solutionKey,
        solutionId,
        fareType,
        currency,
        adtFare,
        adtTax,
        chdFare,
        chdTax,
        qCharge,
        tktFee,
        platformServiceFee,
        comments,
        journeys,
        fareRule,
        rule,
        platingCarrier,
        prices,
        merchantFee,
        adults,
        children,
        infants,
        baggageMap,
        miniRuleMap,
        afterSaleRule,
        infFare,
        infTax,
      ];
}

class JourneyUi extends Equatable {
  final String flightId;
  final int journeyTime;
  final int transferCount;
  final String? lastTktTime;
  final List<Segment> segments;

  const JourneyUi({
    this.flightId = '',
    this.journeyTime = 0,
    this.transferCount = 0,
    this.lastTktTime,
    this.segments = const [],
  });

  JourneyUi copyWith({
    String? flightId,
    int? journeyTime,
    int? transferCount,
    String? lastTktTime,
    List<Segment>? segments,
  }) {
    return JourneyUi(
      flightId: flightId ?? this.flightId,
      journeyTime: journeyTime ?? this.journeyTime,
      transferCount: transferCount ?? this.transferCount,
      lastTktTime: lastTktTime ?? this.lastTktTime,
      segments: segments ?? this.segments,
    );
  }

  factory JourneyUi.fromMap(Map<String, dynamic> map) {
    return JourneyUi(
      flightId: map['flightId'] ?? '',
      journeyTime: map['journeyTime'] ?? 0,
      transferCount: map['transferCount'] ?? 0,
      lastTktTime: map['lastTktTime'],
      segments: (map['segments'] as Map<String, dynamic>?)
              ?.map((segmentKey, segmentData) {
                return MapEntry(
                  segmentKey,
                  Segment.fromMap(segmentData as Map<String, dynamic>),
                );
              })
              .values
              .toList() ??
          [],
    );
  }

  @override
  List<Object?> get props => [
        flightId,
        journeyTime,
        transferCount,
        lastTktTime,
        segments,
      ];
}
